env:
  DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
  NODE_ENV: test

steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'
      cache: 'npm'

  - name: Ensure npm global bin is in PATH
    run: echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

  - name: Install pnpm (global)
    run: npm install -g pnpm@latest

  - name: Verify pnpm
    run: |
      pnpm -v
      node -v
      npm -v

  - name: Cache pnpm store
    uses: actions/cache@v4
    with:
      path: |
        ~/.pnpm-store
        node_modules
      key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
      restore-keys: |
        ${{ runner.os }}-pnpm-

  - name: Install dependencies (pnpm)
    run: pnpm install
    env:
      PNPM_HOME: ~/.pnpm

  - name: Run database migrations (if any)
    run: |
      # If you have migrations, run them here. Example:
      # pnpm exec prisma migrate deploy --preview-feature
      echo "No migrations step configured"
    continue-on-error: true

  - name: Run tests
    run: pnpm test
    env:
      DATABASE_URL: ${{ env.DATABASE_URL }}
